#!/usr/bin/env node

// This script will play back electron-fiddle sessions that were
// recorded with ./electron-fiddle-record

const fs = require('fs');
const hash = require('object-hash');
const path = require('path');

// We only want the args that are passed to electron-fiddle, so remove
// the /path/to/node and /path/to/electron-fiddle args that come first
function removeLeadingArgs(argv) {
  const keep = (arg) => !/(node|electron-fiddle)$/.test(arg);
  return argv.slice(argv.findIndex(keep));
}

function getFilenames(argv) {
  // hash argv to get the session hash
  args = removeLeadingArgs(argv);
  const argv_hash = hash(args);
  // build filenames from the session hash
  const prefix = path.resolve(__dirname, 'electron-fiddle-sessions', argv_hash);
  const logFile = `${prefix}.log`;
  const exitFile = `${prefix}.code`;
  return { args, exitFile, logFile };
}

if (require.main === module) {
  const { args, exitFile, logFile } = getFilenames(process.argv);
  console.log('hashing args:', args.join(' '));
  console.log(fs.readFileSync(logFile, 'utf8'));
  process.exit(Number.parseInt(fs.readFileSync(exitFile, 'utf8')));
}

module.exports = getFilenames;
